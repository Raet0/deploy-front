import{a as K}from"./chunk-MSH2W66A.js";import{b as j,d as k,e as W,f as B,g as O,h as L,k as H,l as q,m as G,o as Z}from"./chunk-C4LGJKLO.js";import{a as z,c as J}from"./chunk-PESOSVUV.js";import{$ as p,B as d,G as F,Ia as D,La as N,Ma as I,N as f,O as x,R as w,S as A,T as S,U as n,V as i,W as E,Wa as y,Ya as V,_ as P,ba as m,fa as M,ia as o,ja as g,l as R,la as U,na as C,o as b,oa as v,p as u,pa as h,q as _,v as c}from"./chunk-TYTM6227.js";var T=class r{http=b(I);auth=b(V);advisorySummary(t){let e=new N;return t?.from&&(e=e.set("from",t.from)),t?.to&&(e=e.set("to",t.to)),t?.status&&(e=e.set("status",t.status)),this.http.get(`${y}/api/reports/advisories`,{headers:this.auth.getAuthHeaders(),params:e})}projectSummary(){return this.http.get(`${y}/api/reports/projects`,{headers:this.auth.getAuthHeaders()})}advisoryPdf(t){let e=new N;return t?.from&&(e=e.set("from",t.from)),t?.to&&(e=e.set("to",t.to)),t?.status&&(e=e.set("status",t.status)),this.http.get(`${y}/api/reports/advisories/pdf`,{headers:this.auth.getAuthHeaders(),params:e,responseType:"blob"})}projectExcel(){return this.http.get(`${y}/api/reports/projects/excel`,{headers:this.auth.getAuthHeaders(),responseType:"blob"})}static \u0275fac=function(e){return new(e||r)};static \u0275prov=R({token:r,factory:r.\u0275fac,providedIn:"root"})};var Y=(r,t)=>t.programmerName+t.status,$=(r,t)=>t.programmerName,ee=(r,t)=>t.email;function te(r,t){if(r&1&&(n(0,"p",6),o(1),i()),r&2){let e=m();d(),g(e.formErrors().name)}}function ie(r,t){if(r&1&&(n(0,"p",6),o(1),i()),r&2){let e=m();d(),g(e.formErrors().email)}}function ne(r,t){if(r&1&&(n(0,"p",6),o(1),i()),r&2){let e=m();d(),g(e.formErrors().password)}}function re(r,t){r&1&&E(0,"span",14)}function oe(r,t){r&1&&(n(0,"p",24),o(1,"Cargando reportes..."),i())}function ae(r,t){if(r&1&&(n(0,"div",40)(1,"span"),o(2),i(),n(3,"span",41),o(4),i()()),r&2){let e=t.$implicit;d(2),U("",e.programmerName," \xB7 ",e.status),d(2),g(e.total)}}function se(r,t){r&1&&(n(0,"p",24),o(1,"Sin datos"),i())}function de(r,t){if(r&1&&(n(0,"div",40)(1,"span"),o(2),i(),n(3,"span",41),o(4),i()()),r&2){let e=t.$implicit;d(2),g(e.programmerName),d(2),g(e.totalActive)}}function le(r,t){r&1&&(n(0,"p",24),o(1,"Sin datos"),i())}function me(r,t){if(r&1){let e=P();n(0,"div",28)(1,"div",29)(2,"p",30),o(3,"Pendientes"),i(),n(4,"p",31),o(5),i(),n(6,"div",32),E(7,"div",33),i()(),n(8,"div",29)(9,"p",30),o(10,"Aprobadas"),i(),n(11,"p",31),o(12),i(),n(13,"div",32),E(14,"div",34),i()(),n(15,"div",29)(16,"p",30),o(17,"Rechazadas"),i(),n(18,"p",31),o(19),i(),n(20,"div",32),E(21,"div",35),i()()(),n(22,"div",36)(23,"button",37),p("click",function(){u(e);let s=m();return _(s.downloadAdvisoryPdf())}),o(24,"Descargar PDF asesor\xEDas"),i(),n(25,"button",37),p("click",function(){u(e);let s=m();return _(s.downloadProjectExcel())}),o(26,"Descargar Excel proyectos"),i()(),n(27,"div",27)(28,"div",38)(29,"h3",39),o(30,"Detalle asesor\xEDas"),i(),w(31,ae,5,3,"div",40,Y,!1,se,2,0,"p",24),i(),n(34,"div",38)(35,"h3",39),o(36,"Proyectos activos"),i(),w(37,de,5,2,"div",40,$,!1,le,2,0,"p",24),i()()}if(r&2){let e=m();d(5),g(e.advisoryTotal("PENDIENTE")),d(2),M("width",e.advisoryPercent("PENDIENTE"),"%"),d(5),g(e.advisoryTotal("APROBADA")),d(2),M("width",e.advisoryPercent("APROBADA"),"%"),d(5),g(e.advisoryTotal("RECHAZADA")),d(2),M("width",e.advisoryPercent("RECHAZADA"),"%"),d(10),A(e.advisorySummary()),d(6),A(e.projectSummary())}}function pe(r,t){if(r&1&&(n(0,"p",6),o(1),i()),r&2){let e=m(2);d(),g(e.editErrors().name)}}function ce(r,t){if(r&1&&(n(0,"p",6),o(1),i()),r&2){let e=m(2);d(),g(e.editErrors().email)}}function ge(r,t){r&1&&E(0,"span",14)}function ue(r,t){if(r&1){let e=P();n(0,"div",2)(1,"h2",3),o(2,"Editar usuario"),i(),n(3,"form",4),p("submit",function(s){u(e);let l=m();return s.preventDefault(),_(l.saveEdit())}),n(4,"div")(5,"input",42),h("ngModelChange",function(s){u(e);let l=m();return v(l.editForm().name,s)||(l.editForm().name=s),_(s)}),p("ngModelChange",function(){u(e);let s=m();return _(s.validateEditForm())}),i(),f(6,pe,2,1,"p",6),i(),n(7,"div")(8,"input",43),h("ngModelChange",function(s){u(e);let l=m();return v(l.editForm().email,s)||(l.editForm().email=s),_(s)}),p("ngModelChange",function(){u(e);let s=m();return _(s.validateEditForm())}),i(),f(9,ce,2,1,"p",6),i(),n(10,"select",44),h("ngModelChange",function(s){u(e);let l=m();return v(l.editForm().role,s)||(l.editForm().role=s),_(s)}),p("ngModelChange",function(){u(e);let s=m();return _(s.validateEditForm())}),n(11,"option",10),o(12,"Programmer"),i(),n(13,"option",11),o(14,"User"),i(),n(15,"option",12),o(16,"Admin"),i()(),n(17,"div",45)(18,"button",13),f(19,ge,1,0,"span",14),o(20," Guardar "),i(),n(21,"button",46),p("click",function(){u(e);let s=m();return _(s.cancelEdit())}),o(22,"Cancelar"),i()()()()}if(r&2){let e=m();d(5),C("ngModel",e.editForm().name),d(),x(e.editErrors().name?6:-1),d(2),C("ngModel",e.editForm().email),d(),x(e.editErrors().email?9:-1),d(),C("ngModel",e.editForm().role),d(8),S("disabled",e.saving()),d(),x(e.saving()?19:-1)}}function _e(r,t){r&1&&(n(0,"p",26),o(1,"Cargando..."),i())}function fe(r,t){if(r&1){let e=P();n(0,"div",47)(1,"h3",49),o(2),i(),n(3,"p"),o(4),i(),n(5,"p",50),o(6),i(),n(7,"div",51)(8,"button",52),p("click",function(){let s=u(e).$implicit,l=m(2);return _(l.startEdit(s))}),o(9,"Editar"),i(),n(10,"button",52),p("click",function(){let s=u(e).$implicit,l=m(2);return _(l.deleteUser(s))}),o(11,"Eliminar"),i()()()}if(r&2){let e=t.$implicit;d(2),g(e.name),d(2),g(e.email),d(2),g(e.role)}}function xe(r,t){r&1&&(n(0,"p",48),o(1,"No hay usuarios registrados."),i())}function Ce(r,t){if(r&1&&(n(0,"div",27),w(1,fe,12,3,"div",47,ee,!1,xe,2,0,"p",48),i()),r&2){let e=m();d(),A(e.users())}}var Q=class r{userService=b(z);reportService=b(T);toast=b(K);users=c([]);loadingUsers=c(!1);saving=c(!1);editingId=c(null);formErrors=c({});editErrors=c({});form=c({name:"",email:"",password:"",role:"PROGRAMMER"});editForm=c({id:void 0,name:"",email:"",role:"USER"});reportFrom=c("");reportTo=c("");reportStatus=c("");loadingReports=c(!1);advisorySummary=c([]);projectSummary=c([]);ngOnInit(){this.loadUsers(),this.loadReports()}loadUsers(){this.loadingUsers.set(!0),this.userService.listUsers().subscribe({next:t=>{this.users.set(t),this.loadingUsers.set(!1)},error:()=>{this.toast.error("No se pudieron cargar usuarios."),this.loadingUsers.set(!1)}})}loadReports(){this.loadingReports.set(!0);let t={from:this.reportFrom()||void 0,to:this.reportTo()||void 0,status:this.reportStatus()||void 0};this.reportService.advisorySummary(t).subscribe({next:e=>{this.advisorySummary.set(e),this.loadingReports.set(!1)},error:()=>{this.toast.error("No se pudieron cargar reportes de asesor\xEDas"),this.loadingReports.set(!1)}}),this.reportService.projectSummary().subscribe({next:e=>this.projectSummary.set(e),error:()=>this.toast.error("No se pudieron cargar reportes de proyectos")})}downloadAdvisoryPdf(){let t={from:this.reportFrom()||void 0,to:this.reportTo()||void 0,status:this.reportStatus()||void 0};this.reportService.advisoryPdf(t).subscribe({next:e=>this.downloadBlob(e,"advisories.pdf"),error:()=>this.toast.error("No se pudo descargar PDF")})}downloadProjectExcel(){this.reportService.projectExcel().subscribe({next:t=>this.downloadBlob(t,"projects.xlsx"),error:()=>this.toast.error("No se pudo descargar Excel")})}addUser(){let t=this.validateCreateForm();if(Object.keys(t).length){this.toast.warning("Revisa los campos resaltados");return}this.saving.set(!0),this.userService.createUser(this.form()).subscribe({next:()=>{this.form.set({name:"",email:"",password:"",role:"PROGRAMMER"}),this.formErrors.set({}),this.toast.success("Usuario creado correctamente"),this.loadUsers(),this.saving.set(!1)},error:e=>{this.toast.error(e?.error?.error||"No se pudo crear el usuario"),this.saving.set(!1)}})}startEdit(t){t.id&&(this.editingId.set(t.id),this.editForm.set({id:t.id,name:t.name,email:t.email,role:t.role?.toUpperCase()||"USER"}),this.validateEditForm())}cancelEdit(){this.editingId.set(null),this.editErrors.set({}),this.editForm.set({id:void 0,name:"",email:"",role:"USER"})}saveEdit(){let t=this.validateEditForm();if(Object.keys(t).length){this.toast.warning("Revisa los campos resaltados");return}let e=this.editForm();e.id&&(this.saving.set(!0),this.userService.updateUser(e.id,{name:e.name,email:e.email,role:e.role}).subscribe({next:()=>{this.toast.success("Usuario actualizado"),this.cancelEdit(),this.loadUsers(),this.saving.set(!1)},error:a=>{this.toast.error(a?.error?.error||"No se pudo actualizar el usuario"),this.saving.set(!1)}}))}deleteUser(t){t.id&&confirm(`Eliminar a ${t.name}?`)&&(this.saving.set(!0),this.userService.deleteUser(t.id).subscribe({next:()=>{this.toast.success("Usuario eliminado"),this.loadUsers(),this.saving.set(!1)},error:e=>{this.toast.error(e?.error?.error||"No se pudo eliminar el usuario"),this.saving.set(!1)}}))}advisoryTotal(t){return this.advisorySummary().filter(e=>e.status===t).reduce((e,a)=>e+a.total,0)}advisoryTotalAll(){return this.advisorySummary().reduce((t,e)=>t+e.total,0)}advisoryPercent(t){let e=this.advisoryTotalAll();return e?Math.round(this.advisoryTotal(t)/e*100):0}validateCreateForm(){let t=this.form(),e={};return(!t.name||t.name.trim().length<2)&&(e.name="Nombre requerido"),t.email||(e.email="Email requerido"),t.email&&!this.isValidEmail(t.email)&&(e.email="Email inv\xE1lido"),t.password||(e.password="Password requerido"),t.password&&t.password.length<6&&(e.password="M\xEDnimo 6 caracteres"),this.formErrors.set(e),e}validateEditForm(){let t=this.editForm(),e={};return(!t.name||t.name.trim().length<2)&&(e.name="Nombre requerido"),t.email||(e.email="Email requerido"),t.email&&!this.isValidEmail(t.email)&&(e.email="Email inv\xE1lido"),this.editErrors.set(e),e}downloadBlob(t,e){let a=window.URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download=e,s.click(),window.URL.revokeObjectURL(a)}isValidEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=F({type:r,selectors:[["app-admin-page"]],decls:60,vars:15,consts:[[1,"max-w-6xl","mx-auto","px-6","py-20","bg-base-100","text-base-content"],[1,"text-4xl","font-extrabold","mb-10","text-center"],[1,"border","border-base-content/20","rounded-2xl","p-6","shadow-md","mb-14","bg-base-200"],[1,"text-2xl","font-semibold","mb-6"],[1,"grid","gap-4",3,"submit"],["placeholder","Nombre","name","name",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],[1,"text-error","text-xs","mt-1"],["placeholder","Email","name","email",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],["placeholder","Password","type","password","name","password",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],["name","role",1,"border","px-4","py-2","rounded-lg","bg-base-100",3,"ngModelChange","ngModel"],["value","PROGRAMMER"],["value","USER"],["value","ADMIN"],[1,"btn","btn-primary",3,"disabled"],[1,"loading","loading-spinner","loading-xs"],[1,"flex","flex-col","md:flex-row","md:items-end","gap-4","mb-6"],[1,"text-sm","font-semibold"],["type","date",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],[1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],["value",""],["value","PENDIENTE"],["value","APROBADA"],["value","RECHAZADA"],[1,"btn","btn-primary",3,"click"],[1,"text-base-content/60"],[1,"text-2xl","font-semibold","mb-6","text-center"],[1,"text-center","text-base-content/60"],[1,"grid","md:grid-cols-2","gap-6"],[1,"grid","md:grid-cols-3","gap-4","mb-8"],[1,"p-4","rounded-xl","bg-base-100"],[1,"text-sm","opacity-60"],[1,"text-3xl","font-bold"],[1,"h-2","bg-base-300","rounded","mt-2"],[1,"h-2","bg-warning","rounded"],[1,"h-2","bg-success","rounded"],[1,"h-2","bg-error","rounded"],[1,"flex","flex-wrap","gap-3","mb-6"],[1,"btn","btn-outline",3,"click"],[1,"bg-base-100","rounded-xl","p-4"],[1,"font-semibold","mb-3"],[1,"flex","justify-between","py-1","text-sm"],[1,"font-semibold"],["placeholder","Nombre","name","editName",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],["placeholder","Email","name","editEmail",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],["name","editRole",1,"border","px-4","py-2","rounded-lg","bg-base-100",3,"ngModelChange","ngModel"],[1,"flex","gap-2"],["type","button",1,"btn","btn-ghost",3,"click"],[1,"border","rounded-2xl","p-6","shadow-md","bg-base-200"],[1,"text-base-content/60","text-center"],[1,"text-xl","font-bold"],[1,"text-sm","text-base-content/70"],[1,"mt-4","flex","gap-2"],[1,"btn","btn-ghost","btn-sm",3,"click"]],template:function(e,a){e&1&&(E(0,"app-drawer"),n(1,"section",0)(2,"h1",1),o(3,"Admin Dashboard"),i(),n(4,"div",2)(5,"h2",3),o(6,"Crear usuario"),i(),n(7,"form",4),p("submit",function(l){return l.preventDefault(),a.addUser()}),n(8,"div")(9,"input",5),h("ngModelChange",function(l){return v(a.form().name,l)||(a.form().name=l),l}),p("ngModelChange",function(){return a.validateCreateForm()}),i(),f(10,te,2,1,"p",6),i(),n(11,"div")(12,"input",7),h("ngModelChange",function(l){return v(a.form().email,l)||(a.form().email=l),l}),p("ngModelChange",function(){return a.validateCreateForm()}),i(),f(13,ie,2,1,"p",6),i(),n(14,"div")(15,"input",8),h("ngModelChange",function(l){return v(a.form().password,l)||(a.form().password=l),l}),p("ngModelChange",function(){return a.validateCreateForm()}),i(),f(16,ne,2,1,"p",6),i(),n(17,"select",9),h("ngModelChange",function(l){return v(a.form().role,l)||(a.form().role=l),l}),p("ngModelChange",function(){return a.validateCreateForm()}),n(18,"option",10),o(19,"Programmer"),i(),n(20,"option",11),o(21,"User"),i(),n(22,"option",12),o(23,"Admin"),i()(),n(24,"button",13),f(25,re,1,0,"span",14),o(26," Crear "),i()()(),n(27,"div",2)(28,"div",15)(29,"div")(30,"label",16),o(31,"Desde"),i(),n(32,"input",17),p("ngModelChange",function(l){return a.reportFrom.set(l)}),i()(),n(33,"div")(34,"label",16),o(35,"Hasta"),i(),n(36,"input",17),p("ngModelChange",function(l){return a.reportTo.set(l)}),i()(),n(37,"div")(38,"label",16),o(39,"Estado"),i(),n(40,"select",18),p("ngModelChange",function(l){return a.reportStatus.set(l)}),n(41,"option",19),o(42,"Todos"),i(),n(43,"option",20),o(44,"PENDIENTE"),i(),n(45,"option",21),o(46,"APROBADA"),i(),n(47,"option",22),o(48,"RECHAZADA"),i()()(),n(49,"button",23),p("click",function(){return a.loadReports()}),o(50,"Aplicar"),i()(),n(51,"h2",3),o(52,"Reportes de asesor\xEDas"),i(),f(53,oe,2,0,"p",24)(54,me,40,11),i(),f(55,ue,23,7,"div",2),n(56,"h2",25),o(57,"Usuarios registrados"),i(),f(58,_e,2,0,"p",26)(59,Ce,4,1,"div",27),i()),e&2&&(d(9),C("ngModel",a.form().name),d(),x(a.formErrors().name?10:-1),d(2),C("ngModel",a.form().email),d(),x(a.formErrors().email?13:-1),d(2),C("ngModel",a.form().password),d(),x(a.formErrors().password?16:-1),d(),C("ngModel",a.form().role),d(7),S("disabled",a.saving()),d(),x(a.saving()?25:-1),d(7),S("ngModel",a.reportFrom()),d(4),S("ngModel",a.reportTo()),d(4),S("ngModel",a.reportStatus()),d(13),x(a.loadingReports()?53:54),d(2),x(a.editingId()?55:-1),d(3),x(a.loadingUsers()?58:59))},dependencies:[D,Z,L,q,G,j,H,k,W,O,B,J],encapsulation:2})};export{Q as AdminPageComponent};
