import{a as ae}from"./chunk-PBVZZ3YF.js";import{a as re}from"./chunk-YEPPDUEW.js";import{b as z,d as G,e as Z,f as J,g as K,h as Q,k as X,l as ee,m as te,o as ie}from"./chunk-7NOJ4FLA.js";import{c as ne}from"./chunk-Z4WB5FUE.js";import{$ as _,B as l,G as R,Ia as O,N as d,O as p,Pa as H,R as v,S as f,Sa as $,T as h,U as a,V as r,W as F,Ya as j,_ as w,a as E,b as P,ba as u,ia as o,ja as g,ka as L,ma as B,na as C,o as T,oa as y,p as A,pa as x,q as M,ta as Y,v as c,z as W}from"./chunk-DDCXKO4N.js";var _e=t=>["/programmers",t],N=(t,e)=>e.id,be=(t,e)=>e.value;function ve(t,e){t&1&&(a(0,"p",7),o(1,"Cargando programadores..."),r())}function fe(t,e){if(t&1){let n=w();a(0,"button",35),o(1,"Seleccionado"),r(),a(2,"button",36),_("click",function(){A(n);let m=u(3);return M(m.clearSelection())}),o(3,"Deseleccionar"),r()}}function he(t,e){if(t&1){let n=w();a(0,"button",37),_("click",function(){A(n);let m=u().$implicit,s=u(2);return M(s.selectProgrammer(m.id))}),o(1,"Seleccionar"),r()}}function Ce(t,e){if(t&1&&(a(0,"div",10)(1,"div",28),F(2,"img",29),a(3,"div")(4,"h3",30),o(5),r(),a(6,"p",31),o(7),r()()(),a(8,"div",32),d(9,fe,4,0)(10,he,2,0,"button",33),a(11,"a",34),o(12,"Ver perfil"),r()()()),t&2){let n,i=e.$implicit,m=u(2);l(2),h("src",i.photoUrl||"https://via.placeholder.com/64",W),l(3),g(i.name),l(2),g(i.specialty),l(2),p(((n=m.selectedProgrammer())==null?null:n.id)===i.id?9:10),l(2),h("routerLink",Y(5,_e,i.id))}}function ye(t,e){t&1&&(a(0,"p",7),o(1,"No hay programadores registrados."),r())}function xe(t,e){if(t&1&&(a(0,"div",8),v(1,Ce,13,7,"div",10,N,!1,ye,2,0,"p",7),r()),t&2){let n=u();l(),f(n.programmers())}}function Se(t,e){t&1&&(a(0,"p",7),o(1,"Cargando disponibilidad..."),r())}function Ee(t,e){if(t&1&&(a(0,"div",38)(1,"p",39),o(2),r(),a(3,"p",40),o(4),r()()),t&2){let n=e.$implicit;l(2),B("",n.day," \xB7 ",n.startTime," - ",n.endTime),l(2),g(n.modality)}}function Pe(t,e){t&1&&(a(0,"p",7),o(1,"Selecciona un programador para ver horarios."),r())}function Te(t,e){if(t&1&&v(0,Ee,5,4,"div",38,N,!1,Pe,2,0,"p",7),t&2){let n=u();f(n.availability())}}function Ae(t,e){if(t&1&&(a(0,"option",16),o(1),r()),t&2){let n=e.$implicit;h("value",n.id),l(),g(n.name)}}function Me(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function Ue(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function Fe(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function we(t,e){t&1&&(a(0,"p",17),o(1,"Email inv\xE1lido"),r())}function Ne(t,e){t&1&&(a(0,"p",20),o(1,"Selecciona un programador primero"),r())}function De(t,e){t&1&&(a(0,"p",20),o(1,"Cargando horarios..."),r())}function Ie(t,e){t&1&&(a(0,"p",21),o(1,"El programador no tiene disponibilidad"),r())}function qe(t,e){if(t&1&&(a(0,"option",16),o(1),r()),t&2){let n=e.$implicit;h("value",n.value),l(),g(n.label)}}function ke(t,e){if(t&1){let n=w();a(0,"select",41),x("ngModelChange",function(m){A(n);let s=u();return y(s.advisoryForm().scheduledAt,m)||(s.advisoryForm().scheduledAt=m),M(m)}),_("blur",function(){A(n);let m=u();return M(m.markTouched("date"))}),a(1,"option",15),o(2,"-- Selecciona un horario --"),r(),v(3,qe,2,2,"option",16,be),r()}if(t&2){let n=u();C("ngModel",n.advisoryForm().scheduledAt),l(3),f(n.availableSchedules())}}function Ve(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function We(t,e){t&1&&F(0,"span",25)}function Re(t,e){t&1&&(a(0,"p",7),o(1,"Cargando solicitudes..."),r())}function Le(t,e){if(t&1&&(a(0,"p",44),o(1),r()),t&2){let n=u().$implicit;l(),L("Respuesta: ",n.response)}}function Be(t,e){if(t&1&&(a(0,"div",42)(1,"p",39),o(2),r(),a(3,"p",40),o(4),r(),a(5,"p",43),o(6,"Estado: "),a(7,"span",39),o(8),r()(),d(9,Le,2,1,"p",44),r()),t&2){let n=e.$implicit;l(2),g(n.programmerName),l(2),g(n.scheduledAt),l(4),g(n.status),l(),p(n.response?9:-1)}}function Ye(t,e){t&1&&(a(0,"p",7),o(1,"No hay solicitudes registradas."),r())}function Oe(t,e){if(t&1&&(a(0,"div",27),v(1,Be,10,4,"div",42,N,!1,Ye,2,0,"p",7),r()),t&2){let n=u();l(),f(n.myAdvisories())}}var oe=class t{programmerService=T(ae);toast=T(re);route=T(H);auth=T(j);programmers=c([]);selectedProgrammer=c(null);availability=c([]);availableSchedules=c([]);advisoryForm=c({});myAdvisories=c([]);sending=c(!1);loadingAdvisories=c(!1);loadingProgrammers=c(!1);loadingAvailability=c(!1);touched=c({programmer:!1,name:!1,email:!1,date:!1});get currentEmail(){return this.auth.currentUser()?.email}ngOnInit(){this.loadProgrammers(),this.route.queryParamMap.subscribe(e=>{let n=Number(e.get("programmerId"));n&&this.selectProgrammer(n)}),this.auth.waitForAuth().then(()=>{this.currentEmail&&this.advisoryForm.update(e=>P(E({},e),{requesterEmail:this.currentEmail})),this.loadMyAdvisories()})}markTouched(e){this.touched.update(n=>P(E({},n),{[e]:!0}))}loadProgrammers(){this.loadingProgrammers.set(!0),this.programmerService.listProgrammersPublic().subscribe({next:e=>{this.programmers.set(e),this.loadingProgrammers.set(!1)},error:()=>{this.toast.error("No se pudo cargar programadores"),this.loadingProgrammers.set(!1)}})}onProgrammerChange(e){if(!e){this.clearSelection();return}this.selectProgrammer(e)}selectProgrammer(e){let n=this.programmers().find(i=>i.id===e)||null;this.selectedProgrammer.set(n),this.advisoryForm.update(i=>P(E({},i),{programmerProfileId:e})),this.loadingAvailability.set(!0),this.programmerService.listAvailabilityPublic(e).subscribe({next:i=>{this.availability.set(i),this.availableSchedules.set(this.generateFutureSchedules(i)),this.loadingAvailability.set(!1)},error:()=>{this.availability.set([]),this.availableSchedules.set([]),this.loadingAvailability.set(!1)}})}generateFutureSchedules(e){if(!e.length)return[];let n=[],i={MONDAY:1,TUESDAY:2,WEDNESDAY:3,THURSDAY:4,FRIDAY:5,SATURDAY:6,SUNDAY:0},m=new Date;for(let s=1;s<=28;s++){let b=new Date(m);b.setDate(b.getDate()+s);let le=b.toLocaleDateString("en-US",{weekday:"long"}).toUpperCase(),D=e.find(I=>I.day===le);if(D){let[I,se]=D.startTime.split(":").map(Number),[q,me]=D.endTime.split(":").map(Number),U=I,S=se;for(;!(U>q||U===q&&S>=me);){let de=b.getFullYear(),pe=String(b.getMonth()+1).padStart(2,"0"),ce=String(b.getDate()).padStart(2,"0"),k=String(U).padStart(2,"0"),V=String(S).padStart(2,"0"),ue=`${de}-${pe}-${ce}T${k}:${V}`,ge=b.toLocaleDateString("es-ES",{weekday:"short",month:"short",day:"numeric"})+" "+k+":"+V;n.push({label:ge,value:ue}),S+=30,S>=60&&(S=0,U+=1)}}}return n}clearSelection(){this.selectedProgrammer.set(null),this.availability.set([]),this.advisoryForm.update(e=>P(E({},e),{programmerProfileId:void 0}))}submit(){let e=this.advisoryForm();if(!e.programmerProfileId||!e.scheduledAt||!e.requesterEmail||!e.requesterName){this.toast.warning("Completa programador, nombre, email y horario");return}if(!this.isValidEmail(e.requesterEmail)){this.toast.warning("Email inv\xE1lido");return}this.sending.set(!0),this.programmerService.createAdvisory({programmerProfileId:e.programmerProfileId,requesterName:e.requesterName,requesterEmail:e.requesterEmail,scheduledAt:e.scheduledAt,comment:e.comment}).subscribe({next:()=>{this.toast.success("Solicitud enviada"),this.loadMyAdvisories(),this.advisoryForm.set({requesterEmail:e.requesterEmail,requesterName:e.requesterName}),this.clearSelection(),this.sending.set(!1)},error:n=>{this.toast.error(n?.error?.error||"No se pudo enviar"),this.sending.set(!1)}})}loadMyAdvisories(){let e=!!this.auth.currentUser(),n=this.currentEmail||this.advisoryForm().requesterEmail;if(!e&&!n){this.toast.warning("No hay email disponible");return}this.loadingAdvisories.set(!0),this.programmerService.listAdvisoriesByRequester(n).subscribe({next:i=>{this.myAdvisories.set(i),this.loadingAdvisories.set(!1),i.length||this.toast.info("No hay solicitudes registradas")},error:()=>{this.toast.error("No se pudieron cargar tus asesor\xEDas"),this.loadingAdvisories.set(!1)}})}countStatus(e){return this.myAdvisories().filter(n=>n.status===e).length}isValidEmail(e){return e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e):!1}isFutureDate(e){return new Date(e).getTime()>Date.now()}isWithinAvailability(e){let n=new Date(e);if(isNaN(n.getTime())||!this.availability().length)return!0;let i=n.toLocaleDateString("en-US",{weekday:"long"}).toUpperCase(),m=n.toTimeString().slice(0,5);return this.availability().some(s=>s.day===i&&m>=s.startTime&&m<=s.endTime)}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=R({type:t,selectors:[["app-user-page"]],decls:73,vars:18,consts:[[1,"max-w-6xl","mx-auto","px-6","py-20","bg-base-100","text-base-content"],[1,"text-4xl","font-extrabold","mb-10","text-center"],[1,"grid","md:grid-cols-3","gap-4","mb-10"],[1,"p-4","rounded-xl","bg-base-200"],[1,"text-sm","opacity-60"],[1,"text-3xl","font-bold"],[1,"text-2xl","font-semibold","mb-4"],[1,"text-base-content/60"],[1,"grid","md:grid-cols-2","gap-8","mb-12"],[1,"border","rounded-2xl","p-6","shadow-md","bg-base-200","mb-10"],[1,"border","rounded-2xl","p-6","shadow-md","bg-base-200"],[1,"text-2xl","font-semibold","mb-6"],[1,"grid","gap-4",3,"submit"],[1,"text-sm","font-semibold"],["name","prog",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel"],["value",""],[3,"value"],[1,"text-error","text-xs","mt-1"],["name","name",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel"],["name","email",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel"],[1,"text-base-content/60","px-4","py-2","border","rounded-lg","bg-base-100"],[1,"text-error","px-4","py-2","border","rounded-lg","bg-base-100"],["name","date",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModel"],["name","comment",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],[1,"btn","btn-primary",3,"disabled"],[1,"loading","loading-spinner","loading-xs"],[1,"mt-12"],[1,"grid","gap-4"],[1,"flex","items-center","gap-4"],[1,"w-16","h-16","rounded-full","object-cover",3,"src"],[1,"text-xl","font-bold"],[1,"text-base-content/70"],[1,"mt-4","flex","gap-2"],[1,"btn","btn-primary","btn-sm"],[1,"btn","btn-ghost","btn-sm",3,"routerLink"],["disabled","",1,"btn","btn-success","btn-sm"],[1,"btn","btn-ghost","btn-sm",3,"click"],[1,"btn","btn-primary","btn-sm",3,"click"],[1,"border","rounded-xl","p-3","bg-base-100","mb-2"],[1,"font-semibold"],[1,"text-sm","text-base-content/60"],["name","date",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel"],[1,"border","rounded-2xl","p-4","bg-base-200"],[1,"mt-2"],[1,"text-base-content/70","mt-2"]],template:function(n,i){n&1&&(F(0,"app-drawer"),a(1,"section",0)(2,"h1",1),o(3,"Agendar Asesor\xEDa"),r(),a(4,"div",2)(5,"div",3)(6,"p",4),o(7,"Pendientes"),r(),a(8,"p",5),o(9),r()(),a(10,"div",3)(11,"p",4),o(12,"Aprobadas"),r(),a(13,"p",5),o(14),r()(),a(15,"div",3)(16,"p",4),o(17,"Rechazadas"),r(),a(18,"p",5),o(19),r()()(),a(20,"h2",6),o(21,"Programadores disponibles"),r(),d(22,ve,2,0,"p",7)(23,xe,4,1,"div",8),a(24,"div",9)(25,"h2",6),o(26,"Disponibilidad"),r(),d(27,Se,2,0,"p",7)(28,Te,3,1),r(),a(29,"div",10)(30,"h2",11),o(31,"Formulario de solicitud"),r(),a(32,"form",12),_("submit",function(s){return s.preventDefault(),i.submit()}),a(33,"div")(34,"label",13),o(35,"Programador *"),r(),a(36,"select",14),x("ngModelChange",function(s){return y(i.advisoryForm().programmerProfileId,s)||(i.advisoryForm().programmerProfileId=s),s}),_("ngModelChange",function(s){return i.onProgrammerChange(s)})("blur",function(){return i.markTouched("programmer")}),a(37,"option",15),o(38,"-- Selecciona programador --"),r(),v(39,Ae,2,2,"option",16,N),r(),d(41,Me,2,0,"p",17),r(),a(42,"div")(43,"label",13),o(44,"Tu nombre *"),r(),a(45,"input",18),x("ngModelChange",function(s){return y(i.advisoryForm().requesterName,s)||(i.advisoryForm().requesterName=s),s}),_("blur",function(){return i.markTouched("name")}),r(),d(46,Ue,2,0,"p",17),r(),a(47,"div")(48,"label",13),o(49,"Tu email *"),r(),a(50,"input",19),x("ngModelChange",function(s){return y(i.advisoryForm().requesterEmail,s)||(i.advisoryForm().requesterEmail=s),s}),_("blur",function(){return i.markTouched("email")}),r(),d(51,Fe,2,0,"p",17),d(52,we,2,0,"p",17),r(),a(53,"div")(54,"label",13),o(55,"Horario disponible *"),r(),d(56,Ne,2,0,"p",20)(57,De,2,0,"p",20)(58,Ie,2,0,"p",21)(59,ke,5,1,"select",22),d(60,Ve,2,0,"p",17),r(),a(61,"div")(62,"label",13),o(63,"Comentario (opcional)"),r(),a(64,"textarea",23),x("ngModelChange",function(s){return y(i.advisoryForm().comment,s)||(i.advisoryForm().comment=s),s}),r()(),a(65,"button",24),d(66,We,1,0,"span",25),o(67," Enviar solicitud "),r()()(),a(68,"div",26)(69,"h2",6),o(70,"Mis solicitudes"),r(),d(71,Re,2,0,"p",7)(72,Oe,4,1,"div",27),r()()),n&2&&(l(9),g(i.countStatus("PENDIENTE")),l(5),g(i.countStatus("APROBADA")),l(5),g(i.countStatus("RECHAZADA")),l(3),p(i.loadingProgrammers()?22:23),l(5),p(i.loadingAvailability()?27:28),l(9),C("ngModel",i.advisoryForm().programmerProfileId),l(3),f(i.programmers()),l(2),p(i.touched().programmer&&!i.advisoryForm().programmerProfileId?41:-1),l(4),C("ngModel",i.advisoryForm().requesterName),l(),p(i.touched().name&&!i.advisoryForm().requesterName?46:-1),l(4),C("ngModel",i.advisoryForm().requesterEmail),l(),p(i.touched().email&&!i.advisoryForm().requesterEmail?51:-1),l(),p(i.touched().email&&i.advisoryForm().requesterEmail&&!i.isValidEmail(i.advisoryForm().requesterEmail)?52:-1),l(4),p(i.selectedProgrammer()?i.loadingAvailability()?57:i.availableSchedules().length===0?58:59:56),l(4),p(i.touched().date&&!i.advisoryForm().scheduledAt?60:-1),l(4),C("ngModel",i.advisoryForm().comment),l(),h("disabled",i.sending()),l(),p(i.sending()?66:-1),l(5),p(i.loadingAdvisories()?71:72))},dependencies:[O,ie,Q,ee,te,z,X,G,Z,K,J,$,ne],encapsulation:2})};export{oe as UserPageComponent};
