import{a as ie}from"./chunk-OFFWETNE.js";import{a as te}from"./chunk-MSH2W66A.js";import{b as Y,d as j,e as z,f as G,g as Z,h as J,k as K,l as Q,m as X,o as $}from"./chunk-C4LGJKLO.js";import{c as ee}from"./chunk-PESOSVUV.js";import{$ as b,B as l,G as k,Ia as R,N as d,O as p,Pa as O,R as f,S as h,Sa as B,T as v,U as a,V as r,W as U,Ya as H,_ as w,a as E,b as P,ba as g,ia as o,ja as u,ka as V,ma as W,na as C,o as T,oa as y,p as A,pa as x,q as M,ta as L,v as c,z as q}from"./chunk-TYTM6227.js";var me=t=>["/programmers",t],F=(t,e)=>e.id,de=(t,e)=>e.value;function pe(t,e){t&1&&(a(0,"p",7),o(1,"Cargando programadores..."),r())}function ce(t,e){if(t&1){let i=w();a(0,"button",35),o(1,"Seleccionado"),r(),a(2,"button",36),b("click",function(){A(i);let m=g(3);return M(m.clearSelection())}),o(3,"Deseleccionar"),r()}}function ge(t,e){if(t&1){let i=w();a(0,"button",37),b("click",function(){A(i);let m=g().$implicit,s=g(2);return M(s.selectProgrammer(m.id))}),o(1,"Seleccionar"),r()}}function ue(t,e){if(t&1&&(a(0,"div",10)(1,"div",28),U(2,"img",29),a(3,"div")(4,"h3",30),o(5),r(),a(6,"p",31),o(7),r()()(),a(8,"div",32),d(9,ce,4,0)(10,ge,2,0,"button",33),a(11,"a",34),o(12,"Ver perfil"),r()()()),t&2){let i,n=e.$implicit,m=g(2);l(2),v("src",n.photoUrl||"https://via.placeholder.com/64",q),l(3),u(n.name),l(2),u(n.specialty),l(2),p(((i=m.selectedProgrammer())==null?null:i.id)===n.id?9:10),l(2),v("routerLink",L(5,me,n.id))}}function _e(t,e){t&1&&(a(0,"p",7),o(1,"No hay programadores registrados."),r())}function be(t,e){if(t&1&&(a(0,"div",8),f(1,ue,13,7,"div",10,F,!1,_e,2,0,"p",7),r()),t&2){let i=g();l(),h(i.programmers())}}function ve(t,e){t&1&&(a(0,"p",7),o(1,"Cargando disponibilidad..."),r())}function fe(t,e){if(t&1&&(a(0,"div",38)(1,"p",39),o(2),r(),a(3,"p",40),o(4),r()()),t&2){let i=e.$implicit;l(2),W("",i.day," \xB7 ",i.startTime," - ",i.endTime),l(2),u(i.modality)}}function he(t,e){t&1&&(a(0,"p",7),o(1,"Selecciona un programador para ver horarios."),r())}function Ce(t,e){if(t&1&&f(0,fe,5,4,"div",38,F,!1,he,2,0,"p",7),t&2){let i=g();h(i.availability())}}function ye(t,e){if(t&1&&(a(0,"option",16),o(1),r()),t&2){let i=e.$implicit;v("value",i.id),l(),u(i.name)}}function xe(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function Se(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function Ee(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function Pe(t,e){t&1&&(a(0,"p",17),o(1,"Email inv\xE1lido"),r())}function Te(t,e){t&1&&(a(0,"p",20),o(1,"Selecciona un programador primero"),r())}function Ae(t,e){t&1&&(a(0,"p",20),o(1,"Cargando horarios..."),r())}function Me(t,e){t&1&&(a(0,"p",21),o(1,"El programador no tiene disponibilidad"),r())}function Ue(t,e){if(t&1&&(a(0,"option",16),o(1),r()),t&2){let i=e.$implicit;v("value",i.value),l(),u(i.label)}}function we(t,e){if(t&1){let i=w();a(0,"select",41),x("ngModelChange",function(m){A(i);let s=g();return y(s.advisoryForm().scheduledAt,m)||(s.advisoryForm().scheduledAt=m),M(m)}),b("blur",function(){A(i);let m=g();return M(m.markTouched("date"))}),a(1,"option",15),o(2,"-- Selecciona un horario --"),r(),f(3,Ue,2,2,"option",16,de),r()}if(t&2){let i=g();C("ngModel",i.advisoryForm().scheduledAt),l(3),h(i.availableSchedules())}}function Fe(t,e){t&1&&(a(0,"p",17),o(1,"Campo obligatorio"),r())}function Ne(t,e){t&1&&U(0,"span",25)}function De(t,e){t&1&&(a(0,"p",7),o(1,"Cargando solicitudes..."),r())}function Ie(t,e){if(t&1&&(a(0,"p",44),o(1),r()),t&2){let i=g().$implicit;l(),V("Respuesta: ",i.response)}}function qe(t,e){if(t&1&&(a(0,"div",42)(1,"p",39),o(2),r(),a(3,"p",40),o(4),r(),a(5,"p",43),o(6,"Estado: "),a(7,"span",39),o(8),r()(),d(9,Ie,2,1,"p",44),r()),t&2){let i=e.$implicit;l(2),u(i.programmerName),l(2),u(i.scheduledAt),l(4),u(i.status),l(),p(i.response?9:-1)}}function ke(t,e){t&1&&(a(0,"p",7),o(1,"No hay solicitudes registradas."),r())}function Ve(t,e){if(t&1&&(a(0,"div",27),f(1,qe,10,4,"div",42,F,!1,ke,2,0,"p",7),r()),t&2){let i=g();l(),h(i.myAdvisories())}}var ne=class t{programmerService=T(ie);toast=T(te);route=T(O);auth=T(H);programmers=c([]);selectedProgrammer=c(null);availability=c([]);availableSchedules=c([]);advisoryForm=c({});myAdvisories=c([]);sending=c(!1);loadingAdvisories=c(!1);loadingProgrammers=c(!1);loadingAvailability=c(!1);touched=c({programmer:!1,name:!1,email:!1,date:!1});get currentEmail(){return this.auth.currentUser()?.email}ngOnInit(){this.loadProgrammers(),this.route.queryParamMap.subscribe(e=>{let i=Number(e.get("programmerId"));i&&this.selectProgrammer(i)}),this.currentEmail&&(this.advisoryForm.update(e=>P(E({},e),{requesterEmail:this.currentEmail})),this.loadMyAdvisories())}markTouched(e){this.touched.update(i=>P(E({},i),{[e]:!0}))}loadProgrammers(){this.loadingProgrammers.set(!0),this.programmerService.listProgrammersPublic().subscribe({next:e=>{this.programmers.set(e),this.loadingProgrammers.set(!1)},error:()=>{this.toast.error("No se pudo cargar programadores"),this.loadingProgrammers.set(!1)}})}onProgrammerChange(e){if(!e){this.clearSelection();return}this.selectProgrammer(e)}selectProgrammer(e){let i=this.programmers().find(n=>n.id===e)||null;this.selectedProgrammer.set(i),this.advisoryForm.update(n=>P(E({},n),{programmerProfileId:e})),this.loadingAvailability.set(!0),this.programmerService.listAvailabilityPublic(e).subscribe({next:n=>{this.availability.set(n),this.availableSchedules.set(this.generateFutureSchedules(n)),this.loadingAvailability.set(!1)},error:()=>{this.availability.set([]),this.availableSchedules.set([]),this.loadingAvailability.set(!1)}})}generateFutureSchedules(e){if(!e.length)return[];let i=[],n={MONDAY:1,TUESDAY:2,WEDNESDAY:3,THURSDAY:4,FRIDAY:5,SATURDAY:6,SUNDAY:0},m=new Date;for(let s=1;s<=28;s++){let S=new Date(m);S.setDate(S.getDate()+s);let re=S.toLocaleDateString("en-US",{weekday:"long"}).toUpperCase(),N=e.find(D=>D.day===re);if(N){let[D,ae]=N.startTime.split(":").map(Number),[oe,le]=N.endTime.split(":").map(Number),_=new Date(S);_.setHours(D,ae,0,0);let I=new Date(S);for(I.setHours(oe,le,0,0);_<I;){let We=_.toISOString().slice(0,16),se=_.toLocaleDateString("es-ES",{weekday:"short",month:"short",day:"numeric"})+" "+_.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});i.push({label:se,value:_.toISOString()}),_.setMinutes(_.getMinutes()+30)}}}return i}clearSelection(){this.selectedProgrammer.set(null),this.availability.set([]),this.advisoryForm.update(e=>P(E({},e),{programmerProfileId:void 0}))}submit(){let e=this.advisoryForm();if(!e.programmerProfileId||!e.scheduledAt||!e.requesterEmail||!e.requesterName){this.toast.warning("Completa programador, nombre, email y horario");return}if(!this.isValidEmail(e.requesterEmail)){this.toast.warning("Email inv\xE1lido");return}this.sending.set(!0),this.programmerService.createAdvisory({programmerProfileId:e.programmerProfileId,requesterName:e.requesterName,requesterEmail:e.requesterEmail,scheduledAt:e.scheduledAt,comment:e.comment}).subscribe({next:()=>{this.toast.success("Solicitud enviada"),this.loadMyAdvisories(),this.advisoryForm.set({requesterEmail:e.requesterEmail,requesterName:e.requesterName}),this.clearSelection(),this.sending.set(!1)},error:i=>{this.toast.error(i?.error?.error||"No se pudo enviar"),this.sending.set(!1)}})}loadMyAdvisories(){let e=this.currentEmail||this.advisoryForm().requesterEmail;if(!e){this.toast.warning("No hay email disponible");return}this.loadingAdvisories.set(!0),this.programmerService.listAdvisoriesByRequester(e).subscribe({next:i=>{this.myAdvisories.set(i),this.loadingAdvisories.set(!1),i.length||this.toast.info("No hay solicitudes registradas")},error:()=>{this.toast.error("No se pudieron cargar tus asesor\xEDas"),this.loadingAdvisories.set(!1)}})}countStatus(e){return this.myAdvisories().filter(i=>i.status===e).length}isValidEmail(e){return e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e):!1}isFutureDate(e){return new Date(e).getTime()>Date.now()}isWithinAvailability(e){let i=new Date(e);if(isNaN(i.getTime())||!this.availability().length)return!0;let n=i.toLocaleDateString("en-US",{weekday:"long"}).toUpperCase(),m=i.toTimeString().slice(0,5);return this.availability().some(s=>s.day===n&&m>=s.startTime&&m<=s.endTime)}static \u0275fac=function(i){return new(i||t)};static \u0275cmp=k({type:t,selectors:[["app-user-page"]],decls:73,vars:19,consts:[[1,"max-w-6xl","mx-auto","px-6","py-20","bg-base-100","text-base-content"],[1,"text-4xl","font-extrabold","mb-10","text-center"],[1,"grid","md:grid-cols-3","gap-4","mb-10"],[1,"p-4","rounded-xl","bg-base-200"],[1,"text-sm","opacity-60"],[1,"text-3xl","font-bold"],[1,"text-2xl","font-semibold","mb-4"],[1,"text-base-content/60"],[1,"grid","md:grid-cols-2","gap-8","mb-12"],[1,"border","rounded-2xl","p-6","shadow-md","bg-base-200","mb-10"],[1,"border","rounded-2xl","p-6","shadow-md","bg-base-200"],[1,"text-2xl","font-semibold","mb-6"],[1,"grid","gap-4",3,"submit"],[1,"text-sm","font-semibold"],["name","prog",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel"],["value",""],[3,"value"],[1,"text-error","text-xs","mt-1"],["name","name",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel"],["name","email",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel","readonly"],[1,"text-base-content/60","px-4","py-2","border","rounded-lg","bg-base-100"],[1,"text-error","px-4","py-2","border","rounded-lg","bg-base-100"],["name","date",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModel"],["name","comment",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","ngModel"],[1,"btn","btn-primary",3,"disabled"],[1,"loading","loading-spinner","loading-xs"],[1,"mt-12"],[1,"grid","gap-4"],[1,"flex","items-center","gap-4"],[1,"w-16","h-16","rounded-full","object-cover",3,"src"],[1,"text-xl","font-bold"],[1,"text-base-content/70"],[1,"mt-4","flex","gap-2"],[1,"btn","btn-primary","btn-sm"],[1,"btn","btn-ghost","btn-sm",3,"routerLink"],["disabled","",1,"btn","btn-success","btn-sm"],[1,"btn","btn-ghost","btn-sm",3,"click"],[1,"btn","btn-primary","btn-sm",3,"click"],[1,"border","rounded-xl","p-3","bg-base-100","mb-2"],[1,"font-semibold"],[1,"text-sm","text-base-content/60"],["name","date",1,"border","px-4","py-2","rounded-lg","bg-base-100","w-full",3,"ngModelChange","blur","ngModel"],[1,"border","rounded-2xl","p-4","bg-base-200"],[1,"mt-2"],[1,"text-base-content/70","mt-2"]],template:function(i,n){i&1&&(U(0,"app-drawer"),a(1,"section",0)(2,"h1",1),o(3,"Agendar Asesor\xEDa"),r(),a(4,"div",2)(5,"div",3)(6,"p",4),o(7,"Pendientes"),r(),a(8,"p",5),o(9),r()(),a(10,"div",3)(11,"p",4),o(12,"Aprobadas"),r(),a(13,"p",5),o(14),r()(),a(15,"div",3)(16,"p",4),o(17,"Rechazadas"),r(),a(18,"p",5),o(19),r()()(),a(20,"h2",6),o(21,"Programadores disponibles"),r(),d(22,pe,2,0,"p",7)(23,be,4,1,"div",8),a(24,"div",9)(25,"h2",6),o(26,"Disponibilidad"),r(),d(27,ve,2,0,"p",7)(28,Ce,3,1),r(),a(29,"div",10)(30,"h2",11),o(31,"Formulario de solicitud"),r(),a(32,"form",12),b("submit",function(s){return s.preventDefault(),n.submit()}),a(33,"div")(34,"label",13),o(35,"Programador *"),r(),a(36,"select",14),x("ngModelChange",function(s){return y(n.advisoryForm().programmerProfileId,s)||(n.advisoryForm().programmerProfileId=s),s}),b("ngModelChange",function(s){return n.onProgrammerChange(s)})("blur",function(){return n.markTouched("programmer")}),a(37,"option",15),o(38,"-- Selecciona programador --"),r(),f(39,ye,2,2,"option",16,F),r(),d(41,xe,2,0,"p",17),r(),a(42,"div")(43,"label",13),o(44,"Tu nombre *"),r(),a(45,"input",18),x("ngModelChange",function(s){return y(n.advisoryForm().requesterName,s)||(n.advisoryForm().requesterName=s),s}),b("blur",function(){return n.markTouched("name")}),r(),d(46,Se,2,0,"p",17),r(),a(47,"div")(48,"label",13),o(49,"Tu email *"),r(),a(50,"input",19),x("ngModelChange",function(s){return y(n.advisoryForm().requesterEmail,s)||(n.advisoryForm().requesterEmail=s),s}),b("blur",function(){return n.markTouched("email")}),r(),d(51,Ee,2,0,"p",17),d(52,Pe,2,0,"p",17),r(),a(53,"div")(54,"label",13),o(55,"Horario disponible *"),r(),d(56,Te,2,0,"p",20)(57,Ae,2,0,"p",20)(58,Me,2,0,"p",21)(59,we,5,1,"select",22),d(60,Fe,2,0,"p",17),r(),a(61,"div")(62,"label",13),o(63,"Comentario (opcional)"),r(),a(64,"textarea",23),x("ngModelChange",function(s){return y(n.advisoryForm().comment,s)||(n.advisoryForm().comment=s),s}),r()(),a(65,"button",24),d(66,Ne,1,0,"span",25),o(67," Enviar solicitud "),r()()(),a(68,"div",26)(69,"h2",6),o(70,"Mis solicitudes"),r(),d(71,De,2,0,"p",7)(72,Ve,4,1,"div",27),r()()),i&2&&(l(9),u(n.countStatus("PENDIENTE")),l(5),u(n.countStatus("APROBADA")),l(5),u(n.countStatus("RECHAZADA")),l(3),p(n.loadingProgrammers()?22:23),l(5),p(n.loadingAvailability()?27:28),l(9),C("ngModel",n.advisoryForm().programmerProfileId),l(3),h(n.programmers()),l(2),p(n.touched().programmer&&!n.advisoryForm().programmerProfileId?41:-1),l(4),C("ngModel",n.advisoryForm().requesterName),l(),p(n.touched().name&&!n.advisoryForm().requesterName?46:-1),l(4),C("ngModel",n.advisoryForm().requesterEmail),v("readonly",n.currentEmail),l(),p(n.touched().email&&!n.advisoryForm().requesterEmail?51:-1),l(),p(n.touched().email&&n.advisoryForm().requesterEmail&&!n.isValidEmail(n.advisoryForm().requesterEmail)?52:-1),l(4),p(n.selectedProgrammer()?n.loadingAvailability()?57:n.availableSchedules().length===0?58:59:56),l(4),p(n.touched().date&&!n.advisoryForm().scheduledAt?60:-1),l(4),C("ngModel",n.advisoryForm().comment),l(),v("disabled",n.sending()),l(),p(n.sending()?66:-1),l(5),p(n.loadingAdvisories()?71:72))},dependencies:[R,$,J,Q,X,Y,K,j,z,Z,G,B,ee],encapsulation:2})};export{ne as UserPageComponent};
